<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloze Reader - Model Testing Framework</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #f5f3f0 0%, #e8e4df 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 40px;
        }

        .model-selection {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .model-selection h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .model-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .model-option:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
        }

        .model-option.selected {
            border-color: #28a745;
            background: #f8fff9;
        }

        .model-option input[type="checkbox"] {
            position: absolute;
            top: 10px;
            right: 10px;
            transform: scale(1.2);
        }

        .model-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .model-provider {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .model-id {
            color: #495057;
            font-size: 0.8rem;
            font-family: monospace;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .progress-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            color: #495057;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .test-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .metric-label {
            color: #6c757d;
            font-weight: 500;
        }

        .metric-value {
            color: #2c3e50;
            font-weight: bold;
        }

        .score-high { color: #28a745; }
        .score-medium { color: #ffc107; }
        .score-low { color: #dc3545; }

        .game-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .game-section.active {
            display: block;
        }

        .game-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 8px;
            background: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .model-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Model Testing Framework</h1>
        <p class="subtitle">Comprehensive evaluation of AI models for the Cloze Reader application</p>

        <div class="model-selection">
            <h2>Select Models to Test</h2>
            <div id="modelGrid" class="model-grid">
                <!-- Models will be populated by JavaScript -->
            </div>
            
            <div class="controls">
                <button id="selectAllBtn" class="btn btn-secondary">Select All</button>
                <button id="clearAllBtn" class="btn btn-secondary">Clear All</button>
                <button id="startTestBtn" class="btn">Start Comprehensive Test</button>
                <button id="testGameBtn" class="btn btn-success">Test Selected Model in Game</button>
            </div>
        </div>

        <div id="progressSection" class="progress-section">
            <h2>Testing Progress</h2>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="statusMessage" class="status-message">Initializing tests...</div>
            <div id="testLog" class="test-log"></div>
        </div>

        <div id="resultsSection" class="results-section">
            <h2>Test Results</h2>
            <p>Results have been saved to the output folder as CSV files.</p>
            <div id="resultsGrid" class="results-grid">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>

        <div id="gameSection" class="game-section">
            <h2>Interactive Game Testing</h2>
            <p>Test the selected model by playing the game. Performance will be logged for analysis.</p>
            <iframe id="gameFrame" class="game-frame" src="about:blank"></iframe>
        </div>
    </div>

    <script type="module">
        import { ModelTestingFramework } from './src/modelTestingFramework.js';

        class ModelTestingUI {
            constructor() {
                this.framework = new ModelTestingFramework();
                this.selectedModels = new Set();
                this.isTestingInProgress = false;
                this.localServerStatus = null;
                
                this.initializeUI();
                this.setupEventListeners();
            }

            async initializeUI() {
                await this.checkLocalServer();
                await this.populateModelGrid();
            }

            async checkLocalServer() {
                this.localServerStatus = await this.framework.testLocalServerConnection();
                if (this.localServerStatus.connected) {
                    console.log('Local LM Studio server detected:', this.localServerStatus.models.length, 'models available');
                    await this.framework.detectLocalModels();
                } else {
                    console.log('Local LM Studio server not available:', this.localServerStatus.error);
                }
            }

            populateModelGrid() {
                const grid = document.getElementById('modelGrid');
                grid.innerHTML = '';

                // Add local server status indicator
                if (this.localServerStatus) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'server-status';
                    statusDiv.style.cssText = `
                        grid-column: 1 / -1;
                        padding: 15px;
                        margin-bottom: 15px;
                        border-radius: 8px;
                        font-weight: bold;
                        text-align: center;
                        ${this.localServerStatus.connected 
                            ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;'
                            : 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
                        }
                    `;
                    
                    if (this.localServerStatus.connected) {
                        statusDiv.innerHTML = `
                            ✓ Local LM Studio Server Connected (Port 1234)<br>
                            <small>${this.localServerStatus.models.length} model(s) available</small>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            ✗ Local LM Studio Server Not Available<br>
                            <small>Start LM Studio on port 1234 to test local models</small>
                        `;
                    }
                    
                    grid.appendChild(statusDiv);
                }

                this.framework.models.forEach(model => {
                    const modelDiv = document.createElement('div');
                    modelDiv.className = 'model-option';
                    modelDiv.dataset.modelId = model.id;
                    
                    // Disable local models if server is not connected
                    const isDisabled = model.provider === 'local' && !this.localServerStatus?.connected;
                    if (isDisabled) {
                        modelDiv.classList.add('disabled');
                        modelDiv.style.opacity = '0.5';
                        modelDiv.style.cursor = 'not-allowed';
                    }
                    
                    const providerLabel = model.provider === 'local' 
                        ? `LOCAL ${this.localServerStatus?.connected ? '(✓)' : '(✗)'}`
                        : model.provider.toUpperCase();
                    
                    modelDiv.innerHTML = `
                        <input type="checkbox" id="model-${model.id}" ${isDisabled ? 'disabled' : ''} />
                        <div class="model-name">${model.name}</div>
                        <div class="model-provider">${providerLabel}</div>
                        <div class="model-id">${model.id}</div>
                    `;
                    
                    const checkbox = modelDiv.querySelector('input');
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            this.selectedModels.add(model);
                            modelDiv.classList.add('selected');
                        } else {
                            this.selectedModels.delete(model);
                            modelDiv.classList.remove('selected');
                        }
                        this.updateControlsState();
                    });
                    
                    if (!isDisabled) {
                        modelDiv.addEventListener('click', (e) => {
                            if (e.target !== checkbox) {
                                checkbox.click();
                            }
                        });
                    }
                    
                    grid.appendChild(modelDiv);
                });
            }

            setupEventListeners() {
                document.getElementById('selectAllBtn').addEventListener('click', () => {
                    this.selectAllModels();
                });

                document.getElementById('clearAllBtn').addEventListener('click', () => {
                    this.clearAllModels();
                });

                document.getElementById('startTestBtn').addEventListener('click', () => {
                    this.startComprehensiveTest();
                });

                document.getElementById('testGameBtn').addEventListener('click', () => {
                    this.startGameTest();
                });
            }

            selectAllModels() {
                this.framework.models.forEach(model => {
                    this.selectedModels.add(model);
                    const modelDiv = document.querySelector(`[data-model-id="${model.id}"]`);
                    const checkbox = modelDiv.querySelector('input');
                    checkbox.checked = true;
                    modelDiv.classList.add('selected');
                });
                this.updateControlsState();
            }

            clearAllModels() {
                this.selectedModels.clear();
                document.querySelectorAll('.model-option').forEach(div => {
                    div.classList.remove('selected');
                    div.querySelector('input').checked = false;
                });
                this.updateControlsState();
            }

            updateControlsState() {
                const hasSelection = this.selectedModels.size > 0;
                document.getElementById('startTestBtn').disabled = !hasSelection || this.isTestingInProgress;
                document.getElementById('testGameBtn').disabled = this.selectedModels.size !== 1 || this.isTestingInProgress;
            }

            async startComprehensiveTest() {
                if (this.selectedModels.size === 0) {
                    alert('Please select at least one model to test.');
                    return;
                }

                this.isTestingInProgress = true;
                this.updateControlsState();
                
                const progressSection = document.getElementById('progressSection');
                const progressFill = document.getElementById('progressFill');
                const statusMessage = document.getElementById('statusMessage');
                const testLog = document.getElementById('testLog');
                
                progressSection.classList.add('active');
                testLog.textContent = '';
                
                const modelsArray = Array.from(this.selectedModels);
                let completedTests = 0;
                
                try {
                    for (let i = 0; i < modelsArray.length; i++) {
                        const model = modelsArray[i];
                        const progress = (i / modelsArray.length) * 100;
                        
                        progressFill.style.width = `${progress}%`;
                        statusMessage.textContent = `Testing ${model.name} (${i + 1}/${modelsArray.length})...`;
                        
                        this.log(`Starting test for ${model.name}...`);
                        
                        try {
                            const result = await this.framework.testModel(model);
                            this.log(`✓ ${model.name} completed - Score: ${result.overallScore.toFixed(1)}`);
                            completedTests++;
                        } catch (error) {
                            this.log(`✗ ${model.name} failed: ${error.message}`);
                        }
                        
                        progressFill.style.width = `${((i + 1) / modelsArray.length) * 100}%`;
                    }
                    
                    statusMessage.textContent = `Testing completed! ${completedTests}/${modelsArray.length} models tested successfully.`;
                    this.log(`\\nTesting completed! Results saved to output folder.`);
                    
                    // Show results
                    this.displayResults();
                    
                } catch (error) {
                    this.log(`\\nTesting failed: ${error.message}`);
                    statusMessage.textContent = 'Testing failed. Check the log for details.';
                } finally {
                    this.isTestingInProgress = false;
                    this.updateControlsState();
                }
            }

            startGameTest() {
                if (this.selectedModels.size !== 1) {
                    alert('Please select exactly one model for game testing.');
                    return;
                }

                const selectedModel = Array.from(this.selectedModels)[0];
                const gameSection = document.getElementById('gameSection');
                const gameFrame = document.getElementById('gameFrame');
                
                // Construct URL with model parameter
                const gameUrl = `index.html?testModel=${encodeURIComponent(selectedModel.id)}&testMode=true`;
                if (selectedModel.provider === 'local') {
                    gameUrl += '&local=true';
                }
                
                gameFrame.src = gameUrl;
                gameSection.classList.add('active');
                
                this.log(`Starting game test with ${selectedModel.name}...`);
            }

            displayResults() {
                const resultsSection = document.getElementById('resultsSection');
                const resultsGrid = document.getElementById('resultsGrid');
                
                resultsGrid.innerHTML = '';
                
                this.framework.testResults.tests.forEach(result => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    
                    const overallScoreClass = this.getScoreClass(result.overallScore);
                    
                    card.innerHTML = `
                        <h3>${result.modelName}</h3>
                        <div class="metric">
                            <span class="metric-label">Overall Score</span>
                            <span class="metric-value ${overallScoreClass}">${result.overallScore?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Word Selection Success</span>
                            <span class="metric-value">${(result.wordSelection?.successRate * 100)?.toFixed(1) || 'N/A'}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Contextualization Success</span>
                            <span class="metric-value">${(result.contextualization?.successRate * 100)?.toFixed(1) || 'N/A'}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Chat Hints Success</span>
                            <span class="metric-value">${(result.chatHints?.successRate * 100)?.toFixed(1) || 'N/A'}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average Response Time</span>
                            <span class="metric-value">${result.wordSelection?.averageTime?.toFixed(0) || 'N/A'}ms</span>
                        </div>
                    `;
                    
                    resultsGrid.appendChild(card);
                });
                
                resultsSection.classList.add('active');
            }

            getScoreClass(score) {
                if (score >= 80) return 'score-high';
                if (score >= 60) return 'score-medium';
                return 'score-low';
            }

            log(message) {
                const testLog = document.getElementById('testLog');
                const timestamp = new Date().toLocaleTimeString();
                testLog.textContent += `[${timestamp}] ${message}\\n`;
                testLog.scrollTop = testLog.scrollHeight;
            }
        }

        // Initialize the testing UI when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            new ModelTestingUI();
        });
    </script>
</body>
</html>